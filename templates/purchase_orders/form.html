{% extends "base.html" %}
{% block title %}{{ page_title or "أمر شراء" }}{% endblock %}

{% block content %}
{% set is_edit = purchase_order is not none %}
{% set due_date_missing = (not is_edit) or (purchase_order and not purchase_order.due_date) %}

<div class="mb-3">
    <h1 class="h5 mb-1">{{ page_title or ("تعديل أمر شراء" if is_edit else "إضافة أمر شراء") }}</h1>
    <p class="text-muted xsmall mb-0">
        {{ "تحديث بيانات أمر الشراء قبل إرساله." if is_edit else "تسجيل أمر شراء جديد مستقل عن الدفعات." }}
    </p>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body">
        {% if due_date_missing %}
            <div class="alert alert-warning small mb-3" role="alert">
                يفضل إضافة تاريخ الاستحقاق لتسهيل متابعة الالتزامات.
            </div>
        {% endif %}
        <form method="post" action="{{ action_url }}" class="row g-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            {% if is_edit %}
                <div class="col-12">
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted xsmall">الحالة الحالية:</span>
                        {% set status_info = status_meta if status_meta is mapping else {'label': purchase_order.status, 'class': 'bg-secondary'} %}
                        <span class="badge {{ status_info.class }}">{{ status_info.label }}</span>
                    </div>
                </div>
            {% endif %}

            <div class="col-12 col-md-4">
                <label for="bo_number" class="form-label">رقم BO</label>
                <input
                    type="text"
                    class="form-control"
                    id="bo_number"
                    name="bo_number"
                    value="{{ purchase_order.bo_number if is_edit else '' }}"
                    required>
            </div>

            <div class="col-12 col-md-4">
                <label for="project_id" class="form-label">المشروع</label>
                <select class="form-select" id="project_id" name="project_id" required>
                    <option value="">اختر مشروعاً</option>
                    {% for project in projects %}
                        <option value="{{ project.id }}" {% if is_edit and purchase_order.project_id == project.id %}selected{% endif %}>
                            {{ project.project_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-12 col-md-4">
                <label for="supplier_id" class="form-label">المورد</label>
                <select class="form-select" id="supplier_id" name="supplier_id">
                    <option value="">اختر مورداً</option>
                    {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}" {% if is_edit and purchase_order.supplier_id == supplier.id %}selected{% endif %}>
                            {{ supplier.name }}{% if supplier.supplier_type %} ({{ supplier.supplier_type }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
                <div class="form-text">إذا لم يكن المورد موجوداً في القائمة، أدخل الاسم أدناه وسيتم إنشاؤه تلقائياً.</div>
            </div>

            <div class="col-12 col-md-4">
                <label for="supplier_name" class="form-label">اسم مورد جديد</label>
                <input
                    type="text"
                    class="form-control"
                    id="supplier_name"
                    name="supplier_name"
                    value="{% if is_edit and not purchase_order.supplier_id %}{{ purchase_order.supplier_name }}{% endif %}">
            </div>

            <div class="col-12 col-md-4">
                <label for="total_amount" class="form-label">إجمالي المبلغ</label>
                <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control"
                    id="total_amount"
                    name="total_amount"
                    value="{{ purchase_order.total_amount if is_edit else '' }}"
                    required>
            </div>

            <div class="col-12 col-md-4">
                <label for="advance_amount" class="form-label">الدفعة المقدمة</label>
                <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control"
                    id="advance_amount"
                    name="advance_amount"
                    value="{{ purchase_order.advance_amount if is_edit else '' }}">
            </div>

            <div class="col-12 col-md-4">
                <label for="due_date" class="form-label">تاريخ الاستحقاق</label>
                <input
                    type="date"
                    class="form-control"
                    id="due_date"
                    name="due_date"
                    value="{{ purchase_order.due_date.strftime('%Y-%m-%d') if is_edit and purchase_order.due_date else '' }}">
                {% if due_date_missing %}
                    <div class="form-text text-warning">يُستحسن تحديد تاريخ الاستحقاق عند توفره.</div>
                {% endif %}
            </div>

            <div class="col-12 col-md-4">
                <label class="form-label">المتبقي</label>
                <input
                    type="text"
                    class="form-control"
                    value="{{ purchase_order.remaining_amount | num(2) if is_edit else '—' }}"
                    readonly>
            </div>

            <div class="col-12 d-flex justify-content-between flex-wrap gap-2">
                <a href="{{ back_url or url_for('purchase_orders.index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-return-right ms-1"></i>
                    العودة للقائمة
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check2-circle ms-1"></i>
                    {{ submit_label or ("حفظ" if is_edit else "إضافة") }}
                </button>
            </div>
        </form>
    </div>
</div>
<script>
    const supplierSelect = document.getElementById("supplier_id");
    const supplierNameInput = document.getElementById("supplier_name");
    if (supplierSelect && supplierNameInput) {
        supplierNameInput.addEventListener("input", () => {
            if (supplierNameInput.value.trim()) {
                supplierSelect.value = "";
            }
        });
        supplierSelect.addEventListener("change", () => {
            if (supplierSelect.value) {
                supplierNameInput.value = "";
            }
        });
    }
</script>
{% endblock %}
