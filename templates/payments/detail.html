{% extends "base.html" %}
{% block title %}تفاصيل الدفعة رقم {{ payment.id }}{% endblock %}

{% block extra_head %}
<style>
    .xsmall {
        font-size: 0.75rem;
    }
    .small-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .badge-status {
        font-size: 0.75rem;
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
    }
    .workflow-timeline {
        position: relative;
        margin: 0;
        padding: 0;
    }
    .workflow-timeline::before {
        content: "";
        position: absolute;
        top: 0.6rem;
        bottom: 0.6rem;
        inset-inline-start: 12px;
        width: 2px;
        background-color: #e0e0e0;
    }
    .workflow-timeline .timeline-item {
        position: relative;
        padding-inline-start: 2.5rem;
        padding-bottom: 0.75rem;
    }
    .workflow-timeline .timeline-item:last-child {
        padding-bottom: 0;
    }
    .workflow-timeline .timeline-badge {
        position: absolute;
        inset-inline-start: 4px;
        top: 0.1rem;
        width: 16px;
        height: 16px;
        border-radius: 999px;
        background-color: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        color: #fff;
    }
    .workflow-timeline .timeline-item.done .timeline-badge {
        background-color: #198754;
    }
    .workflow-timeline .timeline-item.current .timeline-badge {
        background-color: #0d6efd;
    }
    .workflow-timeline .timeline-item.rejected .timeline-badge {
        background-color: #dc3545;
    }
    .workflow-timeline .timeline-title {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.1rem;
    }
    .workflow-timeline .timeline-meta {
        font-size: 0.75rem;
        color: #6c757d;
    }
    .label-muted {
        font-size: 0.8rem;
        color: #6c757d;
        white-space: nowrap;
    }
    .value-strong {
        font-weight: 600;
    }
    .payment-actions .btn {
        width: 100%;
    }
    @media (min-width: 992px) {
        .payment-actions .btn {
            width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
{% set page_title = "تفاصيل الدفعة رقم " ~ payment.id %}
{% set role_name = current_user.role.name if current_user.is_authenticated and current_user.role else '' %}

{# تحديد المرحلة الحالية رقمياً لاستخدامها في التايملاين #}
{% if payment.status == 'draft' %}
    {% set step = 1 %}
{% elif payment.status == 'pending_pm' %}
    {% set step = 2 %}
{% elif payment.status == 'pending_eng' %}
    {% set step = 3 %}
{% elif payment.status == 'pending_finance' %}
    {% set step = 4 %}
{% elif payment.status == 'ready_for_payment' %}
    {% set step = 5 %}
{% elif payment.status == 'paid' %}
    {% set step = 6 %}
{% else %}
    {% set step = 0 %}
{% endif %}

{# هل الدفعة مرفوضة؟ #}
{% set is_rejected = (payment.status == 'rejected') %}

{# صلاحيات #}
{% set can_edit = False %}
{% if role_name in ['admin', 'engineering_manager'] %}
    {% set can_edit = True %}
{% elif role_name == 'engineer' and payment.status == 'draft' and payment.created_by == current_user.id %}
    {% set can_edit = True %}
{% elif role_name == 'project_manager' and payment.status in ['draft', 'pending_pm'] and payment.created_by == current_user.id %}
    {% set can_edit = True %}
{% endif %}

{% set can_delete = (role_name in ['admin', 'engineering_manager']) %}

{% set can_submit_to_pm = (payment.status == 'draft' and role_name in ['admin', 'engineering_manager', 'project_manager', 'engineer']) %}
{% set can_pm_approve = (payment.status == 'pending_pm' and role_name in ['admin', 'engineering_manager', 'project_manager']) %}
{% set can_pm_reject = can_pm_approve %}
{% set can_eng_approve = (payment.status == 'pending_eng' and role_name in ['admin', 'engineering_manager']) %}
{% set can_eng_reject = can_eng_approve %}
{% set can_fin_approve = (payment.status == 'pending_finance' and role_name in ['admin', 'finance']) %}
{% set can_fin_reject = can_fin_approve %}
{% set can_mark_paid = (payment.status == 'ready_for_payment' and role_name in ['admin', 'finance']) %}

{% if role_name in ['chairman', 'dc'] %}
    {% set can_submit_to_pm = False %}
    {% set can_pm_approve = False %}
    {% set can_pm_reject = False %}
    {% set can_eng_approve = False %}
    {% set can_eng_reject = False %}
    {% set can_fin_approve = False %}
    {% set can_fin_reject = False %}
    {% set can_mark_paid = False %}
    {% set can_edit = False %}
    {% set can_delete = False %}
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h5 mb-1">
            تفاصيل الدفعة رقم {{ payment.id }}
        </h1>
        <div class="card-header-subtitle">
            مشروع:
            <span class="fw-semibold">
                {{ payment.project.project_name if payment.project else 'غير محدد' }}
            </span>
        </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('payments.index') }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-right-circle ms-1"></i>
            رجوع لقائمة الدفعات
        </a>
        {% if can_edit %}
            <a href="{{ url_for('payments.edit_payment', payment_id=payment.id) }}"
               class="btn btn-outline-primary btn-sm">
                <i class="bi bi-pencil-square ms-1"></i>
                تعديل بيانات الدفعة
            </a>
        {% endif %}
        {% if can_delete %}
            <form method="post"
                  action="{{ url_for('payments.delete_payment', payment_id=payment.id) }}"
                  class="d-inline-block"
                  onsubmit="return confirm('هل أنت متأكد من حذف هذه الدفعة؟ لا يمكن التراجع عن هذا الإجراء.');">
                {{ csrf_token() if csrf_token is defined }}
                <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-trash ms-1"></i>
                    حذف الدفعة
                </button>
            </form>
        {% endif %}
    </div>
</div>

<div class="row g-3">
    <!-- العمود الرئيسي -->
    <div class="col-lg-8">
        <div class="card mb-3 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="label-muted">حالة الدفعة</span>
                    <div class="mt-1">
                        <span class="badge badge-status bg-{{ payment.status_badge_class }}">
                            {{ payment.human_status }}
                        </span>
                        {% if is_rejected %}
                            <span class="badge bg-danger-subtle text-danger border-0 badge-status">
                                <i class="bi bi-x-circle ms-1"></i>
                                مرفوضة
                            </span>
                        {% endif %}
                    </div>
                </div>
                <div class="text-end">
                    <div class="label-muted">نوع الدفعة</div>
                    <div class="fw-semibold">{{ payment.request_type }}</div>
                    {% if payment.progress_percentage is not none %}
                        <div class="xsmall text-muted mt-1">
                            نسبة الإنجاز الحالية:
                            <span class="fw-semibold">{{ "%.0f"|format(payment.progress_percentage) }}%</span>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">

                {# تنبيه يظهر لمن هو admin أو المدير الهندسي في حالة الرفض مع اسم من رفض #}
                {% if is_rejected and rejection_log and role_name in ['engineering_manager', 'admin'] %}
                    <div class="alert alert-warning xsmall mb-3">
                        تم رفض هذه الدفعة بواسطة:
                        <span class="fw-semibold">
                            {{ rejection_log.decided_by.full_name if rejection_log.decided_by else 'غير معروف' }}
                        </span>
                        {% if rejection_log.step %}
                            <span class="text-muted"> ({{ rejection_log.step }})</span>
                        {% endif %}
                        {% if rejection_log.decided_at %}
                            <br>
                            بتاريخ {{ rejection_log.decided_at.strftime("%Y-%m-%d %H:%M") }}
                        {% endif %}
                        {% if rejection_log.comment %}
                            <br>
                            ملاحظة الرفض: {{ rejection_log.comment }}
                        {% endif %}
                    </div>
                {% endif %}

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="small-label mb-1">المشروع</div>
                        <div class="value-strong">
                            {{ payment.project.project_name if payment.project else 'غير محدد' }}
                        </div>
                        {% if payment.project and payment.project.code %}
                            <div class="xsmall text-muted">
                                كود المشروع: {{ payment.project.code }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="small-label mb-1">المورد / المقاول</div>
                        <div class="value-strong">
                            {{ payment.supplier.name if payment.supplier else 'غير محدد' }}
                        </div>
                        {% if payment.supplier and payment.supplier.supplier_type %}
                            <div class="xsmall text-muted">
                                النوع: {{ payment.supplier.supplier_type }}
                            </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <div class="small-label mb-1">قيمة الدفعة</div>
                        <div class="value-strong">
                            {{ "{:,.0f}".format(payment.amount or 0) }} ج.م
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="small-label mb-1">تاريخ الإنشاء</div>
                        <div class="value-strong">
                            {{ payment.created_at.strftime("%Y-%m-%d %H:%M") if payment.created_at else "" }}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="small-label mb-1">تم إدخال الدفعة بواسطة</div>
                        <div class="value-strong">
                            {{ payment.creator.full_name if payment.creator else 'غير محدد' }}
                        </div>
                    </div>

                    {% if payment.progress_percentage is not none %}
                        <div class="col-md-6">
                            <div class="small-label mb-1">نسبة الإنجاز وقت طلب الدفعة</div>
                            <div class="d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-center mb-1 xsmall">
                                    <span class="text-muted">إنجاز</span>
                                    <span class="fw-semibold">
                                        {{ "%.0f"|format(payment.progress_percentage) }}%
                                    </span>
                                </div>
                                <div class="progress progress-thin">
                                    <div class="progress-bar"
                                         role="progressbar"
                                         style="width: {{ payment.progress_percentage }}%;"
                                         aria-valuenow="{{ payment.progress_percentage }}"
                                         aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {% if payment.description %}
                        <div class="col-12">
                            <div class="small-label mb-1">وصف مختصر للدفعة</div>
                            <div class="border rounded-3 p-2 bg-light-subtle">
                                {{ payment.description }}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# المرفقات #}
        <div class="card mb-3 shadow-sm">
            <div class="card-header">
                <span class="fw-semibold">المرفقات</span>
            </div>
            <div class="card-body">
                {% if payment.attachments %}
                    <ul class="list-group list-group-flush">
                        {% for att in payment.attachments %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold">{{ att.original_filename }}</div>
                                    <div class="xsmall text-muted">
                                        تم الرفع بتاريخ:
                                        {{ att.uploaded_at.strftime("%Y-%m-%d %H:%M") if att.uploaded_at else "" }}
                                    </div>
                                </div>
                                <div>
                                    <a href="{{ url_for('payments.download_attachment', attachment_id=att.id) }}"
                                       class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-download ms-1"></i>
                                        تحميل
                                    </a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-muted xsmall">
                        لا توجد مرفقات مسجلة لهذه الدفعة.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- العمود الجانبي: Workflow + الإجراءات -->
    <div class="col-lg-4">
        <div class="card mb-3 shadow-sm">
            <div class="card-header">
                <span class="fw-semibold">مسار الاعتمادات (Workflow)</span>
            </div>
            <div class="card-body">
                <ol class="workflow-timeline list-unstyled">

                    {# 1) إدخال المهندس #}
                    <li class="timeline-item {% if step >= 1 %}done{% endif %}">
                        <div class="timeline-badge">
                            <i class="bi bi-check"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">إدخال الدفعة بواسطة المهندس</div>
                            <div class="timeline-meta">
                                {% if payment.created_at %}
                                    بتاريخ {{ payment.created_at.strftime("%Y-%m-%d %H:%M") }}
                                    {% if payment.creator %}
                                        – بواسطة {{ payment.creator.full_name }}
                                    {% endif %}
                                {% else %}
                                    لم يتم تسجيل التاريخ
                                {% endif %}
                            </div>
                        </div>
                    </li>

                    {# 2) مدير المشروع #}
                    <li class="timeline-item {% if step > 1 %}done{% elif step == 2 %}current{% endif %}">
                        <div class="timeline-badge">
                            <i class="bi bi-person-check"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">مراجعة مدير المشروع</div>
                            <div class="timeline-meta">
                                {% if pm_decision %}
                                    {% if pm_decision.action == 'approve' %}
                                        تمت الموافقة بواسطة
                                        {{ pm_decision.decided_by.full_name if pm_decision.decided_by else 'غير معروف' }}
                                        بتاريخ {{ pm_decision.decided_at.strftime("%Y-%m-%d %H:%M") if pm_decision.decided_at else '' }}
                                    {% elif pm_decision.action == 'reject' %}
                                        تم الرفض بواسطة
                                        {{ pm_decision.decided_by.full_name if pm_decision.decided_by else 'غير معروف' }}
                                        بتاريخ {{ pm_decision.decided_at.strftime("%Y-%m-%d %H:%M") if pm_decision.decided_at else '' }}
                                    {% endif %}
                                {% else %}
                                    في انتظار اعتماد مدير المشروع
                                {% endif %}
                            </div>
                        </div>
                    </li>

                    {# 3) الإدارة الهندسية #}
                    <li class="timeline-item {% if step > 2 %}done{% elif step == 3 %}current{% endif %}">
                        <div class="timeline-badge">
                            <i class="bi bi-diagram-3"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">مراجعة الإدارة الهندسية</div>
                            <div class="timeline-meta">
                                {% if eng_decision %}
                                    {% if eng_decision.action == 'approve' %}
                                        تمت الموافقة بواسطة
                                        {{ eng_decision.decided_by.full_name if eng_decision.decided_by else 'غير معروف' }}
                                        بتاريخ {{ eng_decision.decided_at.strftime("%Y-%m-%d %H:%M") if eng_decision.decided_at else '' }}
                                    {% elif eng_decision.action == 'reject' %}
                                        تم الرفض بواسطة
                                        {{ eng_decision.decided_by.full_name if eng_decision.decided_by else 'غير معروف' }}
                                        بتاريخ {{ eng_decision.decided_at.strftime("%Y-%m-%d %H:%M") if eng_decision.decided_at else '' }}
                                    {% endif %}
                                {% else %}
                                    في انتظار اعتماد الإدارة الهندسية
                                {% endif %}
                            </div>
                        </div>
                    </li>

                    {# 4) الإدارة المالية #}
                    <li class="timeline-item {% if step > 3 %}done{% elif step == 4 %}current{% endif %}">
                        <div class="timeline-badge">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">مراجعة الإدارة المالية</div>
                            <div class="timeline-meta">
                                {% if fin_decision %}
                                    {% if fin_decision.action == 'approve' %}
                                        تمت الموافقة بواسطة
                                        {{ fin_decision.decided_by.full_name if fin_decision.decided_by else 'غير معروف' }}
                                        بتاريخ {{ fin_decision.decided_at.strftime("%Y-%m-%d %H:%M") if fin_decision.decided_at else '' }}
                                    {% elif fin_decision.action == 'reject' %}
                                        تم الرفض بواسطة
                                        {{ fin_decision.decided_by.full_name if fin_decision.decided_by else 'غير معروف' }}
                                        بتاريخ {{ fin_decision.decided_at.strftime("%Y-%m-%d %H:%M") if fin_decision.decided_at else '' }}
                                    {% endif %}
                                {% else %}
                                    في انتظار اعتماد المالية
                                {% endif %}
                            </div>
                        </div>
                    </li>

                    {# 5) جاهزة للصرف #}
                    <li class="timeline-item {% if step > 4 %}done{% elif step == 5 %}current{% endif %}">
                        <div class="timeline-badge">
                            <i class="bi bi-wallet2"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">جاهزة للصرف</div>
                            <div class="timeline-meta">
                                {% if finance_ready_log and finance_ready_log.action == 'approve' %}
                                    تم تجهيز الدفعة للصرف بواسطة
                                    {{ finance_ready_log.decided_by.full_name if finance_ready_log.decided_by else 'غير معروف' }}
                                    بتاريخ {{ finance_ready_log.decided_at.strftime("%Y-%m-%d %H:%M") if finance_ready_log.decided_at else '' }}
                                {% else %}
                                    لم تُجهّز بعد للصرف
                                {% endif %}
                            </div>
                        </div>
                    </li>

                    {# 6) تم الصرف / مرفوضة #}
                    <li class="timeline-item {% if is_rejected %}rejected{% elif step == 6 %}done{% endif %}">
                        <div class="timeline-badge">
                            {% if is_rejected %}
                                <i class="bi bi-x"></i>
                            {% else %}
                                <i class="bi bi-check2-circle"></i>
                            {% endif %}
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">
                                {% if is_rejected %}
                                    الدفعة مرفوضة
                                {% else %}
                                    تم الصرف
                                {% endif %}
                            </div>
                            <div class="timeline-meta">
                                {% if not is_rejected and paid_log %}
                                    تم الصرف بواسطة
                                    {{ paid_log.decided_by.full_name if paid_log.decided_by else 'غير معروف' }}
                                    بتاريخ {{ paid_log.decided_at.strftime("%Y-%m-%d %H:%M") if paid_log.decided_at else '' }}
                                {% elif is_rejected and rejection_log %}
                                    تم الرفض بواسطة
                                    {{ rejection_log.decided_by.full_name if rejection_log.decided_by else 'غير معروف' }}
                                    بتاريخ {{ rejection_log.decided_at.strftime("%Y-%m-%d %H:%M") if rejection_log.decided_at else '' }}
                                {% elif is_rejected %}
                                    تم الرفض بدون تاريخ محدد
                                {% else %}
                                    لم يتم الصرف بعد
                                {% endif %}
                            </div>
                        </div>
                    </li>

                </ol>
            </div>
        </div>

        <!-- الإجراءات -->
        <div class="card payment-actions shadow-sm">
            <div class="card-header">
                <span class="fw-semibold">الإجراءات المتاحة</span>
            </div>
            <div class="card-body">
                {% if is_rejected %}
                    <div class="alert alert-danger xsmall">
                        تم رفض هذه الدفعة، لا يمكن تنفيذ إجراءات إضافية عليها.
                    </div>
                {% endif %}

                <div class="d-flex flex-column gap-2">
                    {% if can_submit_to_pm and not is_rejected %}
                        <form method="post" action="{{ url_for('payments.submit_to_pm', payment_id=payment.id) }}">
                            {{ csrf_token() if csrf_token is defined }}
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-send ms-1"></i>
                                إرسال لمراجعة مدير المشروع
                            </button>
                        </form>
                    {% endif %}

                    {% if can_pm_approve and not is_rejected %}
                        <form method="post" action="{{ url_for('payments.pm_approve', payment_id=payment.id) }}">
                            {{ csrf_token() if csrf_token is defined }}
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="bi bi-check-circle ms-1"></i>
                                موافقة مدير المشروع
                            </button>
                        </form>
                        <form method="post" action="{{ url_for('payments.pm_reject', payment_id=payment.id) }}">
                            {{ csrf_token() if csrf_token is defined }}
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-x-circle ms-1"></i>
                                رفض من مدير المشروع
                            </button>
                        </form>
                    {% endif %}

                    {% if can_eng_approve and not is_rejected %}
                        <form method="post" action="{{ url_for('payments.eng_approve', payment_id=payment.id) }}">
                            {{ csrf_token() if csrf_token is defined }}
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="bi bi-check-circle ms-1"></i>
                                موافقة الإدارة الهندسية
                            </button>
                        </form>
                        <form method="post" action="{{ url_for('payments.eng_reject', payment_id=payment.id) }}">
                            {{ csrf_token() if csrf_token is defined }}
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-x-circle ms-1"></i>
                                رفض من الإدارة الهندسية
                            </button>
                        </form>
                    {% endif %}

                    {% if can_fin_approve and not is_rejected %}
                        <form method="post" action="{{ url_for('payments.finance_approve', payment_id=payment.id) }}">
                            {{ csrf_token() if csrf_token is defined }}
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="bi bi-check-circle ms-1"></i>
                                موافقة الإدارة المالية
                            </button>
                        </form>
                        <form method="post" action="{{ url_for('payments.finance_reject', payment_id=payment.id) }}">
                            {{ csrf_token() if csrf_token is defined }}
                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-x-circle ms-1"></i>
                                رفض من الإدارة المالية
                            </button>
                        </form>
                    {% endif %}

                    {% if can_mark_paid and not is_rejected %}
                        <form method="post" action="{{ url_for('payments.mark_paid', payment_id=payment.id) }}">
                            {{ csrf_token() if csrf_token is defined }}
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="bi bi-cash-coin ms-1"></i>
                                تأكيد صرف الدفعة
                            </button>
                        </form>
                    {% endif %}

                    {% if not (can_submit_to_pm or can_pm_approve or can_eng_approve or can_fin_approve or can_mark_paid) %}
                        <div class="text-muted xsmall">
                            لا توجد إجراءات متاحة لك على هذه الدفعة حسب صلاحياتك الحالية.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
