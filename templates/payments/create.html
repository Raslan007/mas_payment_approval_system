{% extends "base.html" %}
{% block title %}إضافة دفعة جديدة{% endblock %}

{% block content %}
{% set page_title = "إضافة دفعة جديدة" %}
{% set is_procurement = current_user.role and current_user.role.name == 'procurement' %}

<div class="mb-3">
    <h1 class="h5 mb-1">إضافة دفعة جديدة</h1>
    <p class="text-muted xsmall mb-0">
        إدخال بيانات الدفعة وربطها بالمشروع والمورد/المقاول، تمهيدًا لمسار الاعتمادات.
    </p>
</div>

<div class="bg-white p-4 rounded-3 shadow-sm">
    <form method="post" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="row g-3">
            <!-- المشروع -->
            <div class="col-md-6">
                <label class="form-label">المشروع</label>
                <div class="d-flex gap-2">
                    <select name="project_id" id="project_id" class="form-select" required title="اختر المشروع">
                        <option value="">اختر المشروع...</option>
                        {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.project_name }}</option>
                        {% endfor %}
                    </select>

                    {% if current_user.role and current_user.role.name in ['admin', 'engineering_manager'] %}
                        <a href="{{ url_for('projects.create_project') }}" target="_blank"
                           class="btn btn-outline-secondary">
                            +
                        </a>
                    {% endif %}
                </div>
                {% if current_user.role and current_user.role.name in ['admin', 'engineering_manager'] %}
                    <small class="text-muted xsmall">
                        لو المشروع غير موجود، اضغط (+) لإضافته في تبويب جديد ثم حدّث الصفحة.
                    </small>
                {% endif %}
            </div>

            <!-- المورد / المقاول -->
            <div class="col-md-6">
                <label class="form-label">المورد / المقاول</label>
                <div class="d-flex gap-2">
                    <select name="supplier_id" id="supplier_id" class="form-select" required title="اختر المورد أو المقاول">
                        <option value="">اختر المورد أو المقاول...</option>
                        {% for s in suppliers %}
                            <option value="{{ s.id }}">{{ s.name }} ({{ s.supplier_type }})</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" id="supplier_id_hidden" name="supplier_id" disabled>

                    {% if current_user.role and current_user.role.name in ['admin', 'engineering_manager'] %}
                        <a href="{{ url_for('suppliers.create_supplier') }}" target="_blank"
                           class="btn btn-outline-secondary">
                            +
                        </a>
                    {% endif %}
                </div>
                {% if current_user.role and current_user.role.name in ['admin', 'engineering_manager'] %}
                    <small class="text-muted xsmall">
                        لو المورد/المقاول غير موجود، اضغط (+) لإضافته في تبويب جديد ثم حدّث الصفحة.
                    </small>
                {% endif %}
            </div>

            <!-- نوع الدفعة -->
            <div class="col-md-4">
                <label class="form-label">نوع الدفعة</label>
                <select name="request_type" id="request_type" class="form-select" title="اختر نوع الدفعة">
                    {% if is_procurement %}
                        <option value="مشتريات" selected>مشتريات</option>
                    {% else %}
                        <option value="مقاول">مقاول</option>
                        <option value="مشتريات">مشتريات</option>
                        <option value="عهدة">عهدة</option>
                    {% endif %}
                </select>
            </div>

            <!-- أمر الشراء -->
            <div class="col-md-4 d-none" id="purchase_order_field">
                <label class="form-label">أمر الشراء</label>
                <select name="purchase_order_id" id="purchase_order_id" class="form-select" title="اختر أمر الشراء">
                    <option value="">اختر أمر الشراء...</option>
                    {% for po in purchase_orders %}
                        <option value="{{ po.id }}" data-project-id="{{ po.project_id }}">
                            أمر شراء {{ po.bo_number }} - المتبقي {{ po.remaining_amount | num(2) }}
                        </option>
                    {% endfor %}
                </select>
                <small class="text-muted xsmall">
                    اختر أمر الشراء المرتبط بالمشروع، ويظهر الرصيد المتبقي لكل أمر.
                </small>
            </div>

            <!-- المبلغ -->
            <div class="col-md-4">
                <label class="form-label">المبلغ</label>
                <input type="number" step="0.01" name="amount" id="amount" class="form-control"
                       required title="أدخل المبلغ" placeholder="أدخل المبلغ">
                <small class="text-muted xsmall d-none" id="po_autofill_hint">
                    تم تعبئة المورد والمبلغ تلقائيًا حسب أمر الشراء المختار.
                </small>
                <small class="text-danger xsmall d-none" id="po_autofill_error"></small>
                {% if show_po_debug %}
                    <pre id="po_prefill_debug" class="mt-2 small text-muted border rounded p-2 bg-light"></pre>
                {% endif %}
            </div>

            <!-- نسبة الإنجاز -->
            <div class="col-md-4">
                <label class="form-label">نسبة الإنجاز وقت هذه الدفعة (%)</label>
                <input type="number" step="0.01" min="0" max="100"
                       name="progress_percentage"
                       class="form-control"
                       placeholder="مثال: 25 أو 50.5">
                <small class="text-muted xsmall">
                    اختياري – يمثل نسبة إنجاز بند/مرحلة المشروع عند طلب هذه الدفعة.
                </small>
            </div>

            <!-- الوصف -->
            <div class="col-12">
                <label class="form-label">وصف / ملاحظات</label>
                <textarea name="description" rows="3" class="form-control"
                          placeholder="أدخل الوصف أو الملاحظات"></textarea>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <a href="{{ url_for('payments.index') }}" class="btn btn-outline-secondary">
                رجوع
            </a>
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check2-circle ms-1"></i>
                حفظ الدفعة
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const requestType = document.getElementById("request_type");
        const projectSelect = document.getElementById("project_id");
        const purchaseOrderField = document.getElementById("purchase_order_field");
        const purchaseOrderSelect = document.getElementById("purchase_order_id");
        const supplierSelect = document.getElementById("supplier_id");
        const supplierHidden = document.getElementById("supplier_id_hidden");
        const amountInput = document.getElementById("amount");
        const poHint = document.getElementById("po_autofill_hint");
        const poError = document.getElementById("po_autofill_error");
        const debugEl = document.getElementById("po_prefill_debug");
        const showDebug = {{ "true" if show_po_debug else "false" }};
        const purchaseOrderOptionsUrl = "{{ url_for('payments.purchase_order_options') }}";
        const purchaseOrderPrefillBase = "{{ url_for('payments.purchase_order_prefill', purchase_order_id=0) }}";

        if (
            !requestType
            || !projectSelect
            || !purchaseOrderField
            || !purchaseOrderSelect
            || !supplierSelect
            || !supplierHidden
            || !amountInput
            || !poHint
            || !poError
        ) {
            return;
        }

        let isLocked = false;

        const clearError = () => {
            poError.textContent = "";
            poError.classList.add("d-none");
        };

        const showError = (message) => {
            if (!message) {
                return;
            }
            poError.textContent = message;
            poError.classList.remove("d-none");
        };

        const updateDebug = ({
            status = "-",
            url = "-",
            supplierId = "-",
            amount = "-",
            error = "-",
        } = {}) => {
            if (!showDebug || !debugEl) {
                return;
            }
            debugEl.textContent = [
                `Prefill URL: ${url}`,
                `Status: ${status}`,
                `Supplier ID: ${supplierId}`,
                `Amount: ${amount}`,
                `Error: ${error}`,
            ].join("\n");
        };

        const triggerSupplierChange = () => {
            supplierSelect.dispatchEvent(new Event("change", { bubbles: true }));
            if (window.jQuery && window.jQuery.fn && window.jQuery.fn.select2) {
                window.jQuery(supplierSelect).trigger("change");
            }
        };

        const triggerAmountChange = () => {
            amountInput.dispatchEvent(new Event("input", { bubbles: true }));
            amountInput.dispatchEvent(new Event("change", { bubbles: true }));
        };

        const setLockedState = (locked) => {
            isLocked = locked;
            supplierSelect.disabled = locked;
            amountInput.readOnly = locked;
            supplierHidden.disabled = !locked;
            if (locked) {
                supplierHidden.value = supplierSelect.value || "";
                poHint.classList.remove("d-none");
            } else {
                supplierHidden.value = "";
                poHint.classList.add("d-none");
            }
        };

        const clearPrefill = () => {
            setLockedState(false);
            supplierSelect.value = "";
            triggerSupplierChange();
            amountInput.value = "";
            triggerAmountChange();
            clearError();
            updateDebug();
        };

        const applyPrefill = (payload) => {
            const supplierId = payload.supplier_id ? String(payload.supplier_id) : "";
            const amountValue = payload.amount || payload.suggested_amount || "";
            supplierSelect.value = supplierId;
            triggerSupplierChange();
            amountInput.value = amountValue;
            triggerAmountChange();
            setLockedState(true);
            clearError();
            updateDebug({
                status: "ok",
                url: payload.prefill_url || "-",
                supplierId,
                amount: amountValue || "-",
                error: "-",
            });
        };

        const resetPurchaseOrderOptions = () => {
            purchaseOrderSelect.innerHTML = "";
            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "اختر أمر الشراء...";
            purchaseOrderSelect.appendChild(placeholder);
            purchaseOrderSelect.value = "";
        };

        const populatePurchaseOrders = (purchaseOrders, selectedValue) => {
            resetPurchaseOrderOptions();
            purchaseOrders.forEach((purchaseOrder) => {
                const option = document.createElement("option");
                option.value = purchaseOrder.id;
                option.textContent = `${purchaseOrder.bo_number} (المتبقي: ${purchaseOrder.remaining_amount})`;
                purchaseOrderSelect.appendChild(option);
            });
            if (
                selectedValue
                && purchaseOrderSelect.querySelector(`option[value="${selectedValue}"]`)
            ) {
                purchaseOrderSelect.value = selectedValue;
            }
        };

        const buildPrefillUrl = (poId, projectId) => {
            const base = purchaseOrderPrefillBase.replace(
                /\/0\/prefill$/,
                `/${encodeURIComponent(poId)}/prefill`
            );
            return `${base}?project_id=${encodeURIComponent(projectId)}`;
        };

        const loadPurchaseOrders = async (selectedValue) => {
            const isPurchase = (requestType.value || "").trim() === "مشتريات";
            purchaseOrderField.classList.toggle("d-none", !isPurchase);
            purchaseOrderSelect.required = isPurchase;

            if (!isPurchase) {
                resetPurchaseOrderOptions();
                purchaseOrderSelect.disabled = true;
                clearPrefill();
                return;
            }

            const projectId = projectSelect.value;
            if (!projectId) {
                resetPurchaseOrderOptions();
                purchaseOrderSelect.disabled = true;
                clearPrefill();
                return;
            }

            try {
                const response = await fetch(
                    `${purchaseOrderOptionsUrl}?project_id=${encodeURIComponent(projectId)}`
                );
                if (!response.ok) {
                    throw new Error("Failed to load purchase orders.");
                }
                const payload = await response.json();
                const purchaseOrders = Array.isArray(payload.purchase_orders)
                    ? payload.purchase_orders
                    : [];
                populatePurchaseOrders(purchaseOrders, selectedValue);
                purchaseOrderSelect.disabled = purchaseOrders.length === 0;
            } catch (error) {
                console.error("Failed to load purchase orders", error);
                resetPurchaseOrderOptions();
                purchaseOrderSelect.disabled = true;
                clearPrefill();
            }
        };

        const handlePurchaseOrderChange = async () => {
            const isPurchase = (requestType.value || "").trim() === "مشتريات";
            const projectId = projectSelect.value;
            const purchaseOrderId = purchaseOrderSelect.value;
            if (!isPurchase || !projectId || !purchaseOrderId) {
                clearPrefill();
                return;
            }
            const prefillUrl = buildPrefillUrl(purchaseOrderId, projectId);
            try {
                const response = await fetch(prefillUrl);
                if (!response.ok) {
                    const payload = await response.json().catch(() => ({}));
                    updateDebug({
                        status: response.status,
                        url: prefillUrl,
                        supplierId: payload.supplier_id || "-",
                        amount: payload.amount || "-",
                        error: payload.error || "prefill_failed",
                    });
                    throw new Error(payload.error || "prefill_failed");
                }
                const payload = await response.json();
                if (payload && payload.ok) {
                    applyPrefill({ ...payload, prefill_url: prefillUrl });
                    return;
                }
                updateDebug({
                    status: response.status,
                    url: prefillUrl,
                    supplierId: payload.supplier_id || "-",
                    amount: payload.amount || "-",
                    error: payload.error || "prefill_failed",
                });
            } catch (error) {
                console.error("Purchase order prefill failed", error);
            }
            showError("تعذر تعبئة بيانات أمر الشراء. يرجى المحاولة مرة أخرى.");
            setLockedState(false);
            updateDebug({ status: "error", url: prefillUrl, error: "prefill_failed" });
        };

        requestType.addEventListener("change", () => {
            purchaseOrderSelect.value = "";
            clearPrefill();
            loadPurchaseOrders();
        });
        projectSelect.addEventListener("change", () => {
            purchaseOrderSelect.value = "";
            clearPrefill();
            loadPurchaseOrders();
        });
        purchaseOrderSelect.addEventListener("change", handlePurchaseOrderChange);
        loadPurchaseOrders();
    });
</script>
{% endblock %}
