{% extends "base.html" %}
{% block title %}{{ page_title or "تعديل الدفعة" }}{% endblock %}

{% block content %}
{% set page_title = page_title or ("تعديل الدفعة رقم " ~ payment.id) %}
{% set is_procurement = current_user.role and current_user.role.name == 'procurement' %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h5 mb-1">{{ page_title }}</h1>
        <div class="card-header-subtitle">
            قم بتعديل بيانات الدفعة ثم اضغط حفظ.
        </div>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('payments.detail', payment_id=payment.id) }}"
           class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-right-circle ms-1"></i>
            رجوع لتفاصيل الدفعة
        </a>
        <a href="{{ url_for('payments.index') }}"
           class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-list-task ms-1"></i>
            قائمة الدفعات
        </a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">

        <form method="post"
              action="{{ url_for('payments.edit_payment', payment_id=payment.id) }}"
              enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="row g-3">

                <!-- المشروع -->
                <div class="col-md-6">
                    <label for="project_id" class="form-label small mb-1">المشروع</label>
                    <select class="form-select form-select-sm" id="project_id" name="project_id" required>
                        <option value="">اختر المشروع...</option>
                        {% for proj in projects %}
                            <option value="{{ proj.id }}"
                                {% if payment.project_id == proj.id %}selected{% endif %}>
                                {{ proj.project_name }}
                                {% if proj.code %}- ({{ proj.code }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- المورد / المقاول -->
                <div class="col-md-6">
                    <label for="supplier_id" class="form-label small mb-1">المورد / المقاول</label>
                    <select class="form-select form-select-sm" id="supplier_id" name="supplier_id" required>
                        <option value="">اختر المورد / المقاول...</option>
                        {% for s in suppliers %}
                            <option value="{{ s.id }}"
                                {% if payment.supplier_id == s.id %}selected{% endif %}>
                                {{ s.name }}
                                {% if s.supplier_type %}- ({{ s.supplier_type }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    <input type="hidden" id="supplier_id_hidden" name="supplier_id" disabled>
                </div>

                <!-- نوع الدفعة -->
                <div class="col-md-6">
                    <label for="request_type" class="form-label small mb-1">نوع الدفعة</label>
                    <select class="form-select form-select-sm" id="request_type" name="request_type" required>
                        {% if is_procurement %}
                            <option value="{{ payment.request_type }}">{{ payment.request_type }}</option>
                        {% else %}
                            <option value="">اختر نوع الدفعة...</option>
                            {% for rt in request_types %}
                                <option value="{{ rt }}"
                                    {% if payment.request_type == rt %}selected{% endif %}>
                                    {{ rt }}
                                </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- أمر الشراء -->
                <div class="col-md-6 {% if payment.request_type != 'مشتريات' %}d-none{% endif %}" id="purchase_order_field">
                    <label for="purchase_order_id" class="form-label small mb-1">أمر الشراء</label>
                    <select class="form-select form-select-sm" id="purchase_order_id" name="purchase_order_id">
                        <option value="">اختر أمر الشراء...</option>
                        {% for po in purchase_orders %}
                            <option value="{{ po.id }}" data-project-id="{{ po.project_id }}"
                                {% if payment.purchase_order_id == po.id %}selected{% endif %}>
                                أمر شراء {{ po.bo_number }} - المتبقي {{ po.remaining_amount | num(2) }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="form-text xsmall">
                        حدد أمر الشراء المرتبط بالدفعة لطلبات المشتريات.
                    </div>
                </div>

                <!-- قيمة الدفعة -->
                <div class="col-md-6">
                    <label for="amount" class="form-label small mb-1">قيمة الدفعة (ج.م)</label>
                    <input type="number" step="0.01" min="0"
                           class="form-control form-control-sm"
                           id="amount" name="amount"
                           value="{{ payment.amount }}"
                           required>
                    <div class="form-text xsmall d-none" id="po_autofill_hint">
                        تم تعبئة المورد والمبلغ تلقائيًا حسب أمر الشراء المختار.
                    </div>
                    <div class="form-text xsmall text-danger d-none" id="po_autofill_error"></div>
                    {% if show_po_debug %}
                        <pre id="po_prefill_debug" class="mt-2 small text-muted border rounded p-2 bg-light"></pre>
                    {% endif %}
                </div>

                <!-- نسبة الإنجاز -->
                <div class="col-md-6">
                    <label for="progress_percentage" class="form-label small mb-1">
                        نسبة الإنجاز وقت طلب الدفعة (%)
                    </label>
                    <input type="number" step="1" min="0" max="100"
                           class="form-control form-control-sm"
                           id="progress_percentage" name="progress_percentage"
                           value="{{ payment.progress_percentage if payment.progress_percentage is not none }}">
                    <div class="form-text xsmall">
                        أدخل نسبة الإنجاز التقريبية وقت طلب هذه الدفعة.
                    </div>
                </div>

                <!-- وصف الدفعة -->
                <div class="col-12">
                    <label for="description" class="form-label small mb-1">وصف مختصر للدفعة</label>
                    <textarea class="form-control form-control-sm"
                              id="description" name="description"
                              rows="3"
                              placeholder="مثال: دفعة مستخلص رقم 3 للمقاول ...">{{ payment.description or "" }}</textarea>
                </div>

                <!-- المرفقات (اختياري) -->
                <div class="col-12">
                    <label for="attachment" class="form-label small mb-1">
                        مرفقات إضافية (اختياري)
                    </label>
                    <input type="file"
                           class="form-control form-control-sm"
                           id="attachment" name="attachment"
                           disabled>
                    <div class="form-text xsmall text-muted">
                        رفع المرفقات سيتم تفعيله قريباً.
                    </div>
                    {% if payment.attachments and config.ATTACHMENTS_ENABLED %}
                        <div class="mt-2 xsmall">
                            المرفقات الحالية:
                            <ul class="mb-0">
                                {% for att in payment.attachments %}
                                    <li>
                                        <a href="{{ url_for('payments.download_attachment', attachment_id=att.id) }}">
                                            {{ att.original_filename }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% elif payment.attachments %}
                        <div class="mt-2 xsmall text-muted">
                            تم تعطيل تحميل المرفقات حالياً.
                        </div>
                    {% endif %}
                </div>

            </div>

            <hr class="my-4">

            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted xsmall">
                    آخر تحديث:
                    {% if payment.updated_at %}
                        {{ payment.updated_at.strftime("%Y-%m-%d %H:%M") }}
                    {% else %}
                        لم يتم التحديث بعد
                    {% endif %}
                </div>

                <div class="d-flex gap-2">
                    <small class="text-danger xsmall d-none align-self-center" id="po_submit_error">
                        تعذر تحميل بيانات أمر الشراء
                    </small>
                    <a href="{{ url_for('payments.detail', payment_id=payment.id) }}"
                       class="btn btn-outline-secondary btn-sm">
                        إلغاء
                    </a>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-save ms-1"></i>
                        حفظ التعديلات
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const requestType = document.getElementById("request_type");
        const projectSelect = document.getElementById("project_id");
        const purchaseOrderField = document.getElementById("purchase_order_field");
        const purchaseOrderSelect = document.getElementById("purchase_order_id");
        const supplierSelect = document.getElementById("supplier_id");
        const supplierHidden = document.getElementById("supplier_id_hidden");
        const amountInput = document.getElementById("amount");
        const poHint = document.getElementById("po_autofill_hint");
        const poError = document.getElementById("po_autofill_error");
        const debugEl = document.getElementById("po_prefill_debug");
        const submitButton = document.querySelector('button[type="submit"]');
        const submitError = document.getElementById("po_submit_error");
        const showDebug = {{ "true" if show_po_debug else "false" }};
        const purchaseOrderOptionsUrl = "{{ url_for('payments.purchase_order_options') }}";
        const purchaseOrderPrefillBase = "{{ url_for('payments.purchase_order_prefill', purchase_order_id=0) }}";

        if (
            !requestType
            || !projectSelect
            || !purchaseOrderField
            || !purchaseOrderSelect
            || !supplierSelect
            || !supplierHidden
            || !amountInput
            || !poHint
            || !poError
        ) {
            return;
        }

        let isLocked = false;
        let manualSupplierId = supplierSelect.value;
        let manualAmount = amountInput.value;

        const updateManualValues = () => {
            if (!isLocked) {
                manualSupplierId = supplierSelect.value;
                manualAmount = amountInput.value;
            }
        };

        const clearError = () => {
            poError.textContent = "";
            poError.classList.add("d-none");
        };

        const showError = (message) => {
            if (!message) {
                return;
            }
            poError.textContent = message;
            poError.classList.remove("d-none");
        };

        const updateDebug = ({
            status = "-",
            url = "-",
            supplierId = "-",
            amount = "-",
            error = "-",
        } = {}) => {
            if (!showDebug || !debugEl) {
                return;
            }
            debugEl.textContent = [
                `Prefill URL: ${url}`,
                `Status: ${status}`,
                `Supplier ID: ${supplierId}`,
                `Amount: ${amount}`,
                `Error: ${error}`,
            ].join("\n");
        };

        const triggerSupplierChange = () => {
            supplierSelect.dispatchEvent(new Event("change", { bubbles: true }));
            if (window.jQuery && window.jQuery.fn && window.jQuery.fn.select2) {
                window.jQuery(supplierSelect).trigger("change");
            }
        };

        const triggerAmountChange = () => {
            amountInput.dispatchEvent(new Event("input", { bubbles: true }));
            amountInput.dispatchEvent(new Event("change", { bubbles: true }));
        };

        const setLockedState = (locked) => {
            isLocked = locked;
            supplierSelect.disabled = locked;
            amountInput.readOnly = locked;
            supplierHidden.disabled = !locked;
            if (locked) {
                supplierHidden.value = supplierSelect.value || "";
                poHint.classList.remove("d-none");
            } else {
                supplierHidden.value = "";
                poHint.classList.add("d-none");
            }
        };

        const setSubmitBlocked = (blocked) => {
            if (!submitButton || !submitError) {
                return;
            }
            submitButton.disabled = blocked;
            submitError.classList.toggle("d-none", !blocked);
        };

        const restoreManualValues = () => {
            supplierSelect.value = manualSupplierId || "";
            triggerSupplierChange();
            amountInput.value = manualAmount || "";
            triggerAmountChange();
        };

        const clearPrefill = () => {
            setLockedState(false);
            restoreManualValues();
            clearError();
            setSubmitBlocked(false);
            updateDebug();
        };

        const applyPrefill = (payload) => {
            const supplierId = payload.supplier_id ? String(payload.supplier_id) : "";
            const amountValue = payload.amount || payload.suggested_amount || "";
            supplierSelect.value = supplierId;
            triggerSupplierChange();
            amountInput.value = amountValue;
            triggerAmountChange();
            setLockedState(true);
            clearError();
            updateDebug({
                status: "ok",
                url: payload.prefill_url || "-",
                supplierId,
                amount: amountValue || "-",
                error: "-",
            });
            setSubmitBlocked(false);
        };

        const clearPrefillFields = () => {
            setLockedState(false);
            supplierSelect.value = "";
            triggerSupplierChange();
            amountInput.value = "";
            triggerAmountChange();
            manualSupplierId = "";
            manualAmount = "";
        };

        const handlePrefillFailure = (errorMessage, prefillUrl) => {
            clearPrefillFields();
            showError(errorMessage);
            setSubmitBlocked(Boolean(purchaseOrderSelect.value));
            updateDebug({ status: "error", url: prefillUrl, error: errorMessage || "prefill_failed" });
        };

        const resetPurchaseOrderOptions = () => {
            purchaseOrderSelect.innerHTML = "";
            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "اختر أمر الشراء...";
            purchaseOrderSelect.appendChild(placeholder);
            purchaseOrderSelect.value = "";
        };

        const populatePurchaseOrders = (purchaseOrders, selectedValue) => {
            resetPurchaseOrderOptions();
            purchaseOrders.forEach((purchaseOrder) => {
                const option = document.createElement("option");
                option.value = purchaseOrder.id;
                option.textContent = `${purchaseOrder.bo_number} (المتبقي: ${purchaseOrder.remaining_amount})`;
                purchaseOrderSelect.appendChild(option);
            });
            if (
                selectedValue
                && purchaseOrderSelect.querySelector(`option[value="${selectedValue}"]`)
            ) {
                purchaseOrderSelect.value = selectedValue;
            }
        };

        const buildPrefillUrl = (poId, projectId) => {
            const base = purchaseOrderPrefillBase.replace(
                /\/0\/prefill$/,
                `/${encodeURIComponent(poId)}/prefill`
            );
            return `${base}?project_id=${encodeURIComponent(projectId)}`;
        };

        const loadPurchaseOrders = async (selectedValue) => {
            const isPurchase = (requestType.value || "").trim() === "مشتريات";
            purchaseOrderField.classList.toggle("d-none", !isPurchase);
            purchaseOrderSelect.required = isPurchase;

            if (!isPurchase) {
                resetPurchaseOrderOptions();
                purchaseOrderSelect.disabled = true;
                clearPrefill();
                return;
            }

            const projectId = projectSelect.value;
            if (!projectId) {
                resetPurchaseOrderOptions();
                purchaseOrderSelect.disabled = true;
                clearPrefill();
                return;
            }

            try {
                const response = await fetch(
                    `${purchaseOrderOptionsUrl}?project_id=${encodeURIComponent(projectId)}`
                );
                if (!response.ok) {
                    throw new Error("Failed to load purchase orders.");
                }
                const payload = await response.json();
                const purchaseOrders = Array.isArray(payload.purchase_orders)
                    ? payload.purchase_orders
                    : [];
                populatePurchaseOrders(purchaseOrders, selectedValue);
                purchaseOrderSelect.disabled = purchaseOrders.length === 0;
            } catch (error) {
                console.error("Failed to load purchase orders", error);
                resetPurchaseOrderOptions();
                purchaseOrderSelect.disabled = true;
                clearPrefill();
            }
        };

        const handlePurchaseOrderChange = async () => {
            const isPurchase = (requestType.value || "").trim() === "مشتريات";
            const projectId = projectSelect.value;
            const purchaseOrderId = purchaseOrderSelect.value;
            if (!isPurchase || !projectId || !purchaseOrderId) {
                clearPrefill();
                return;
            }
            const prefillUrl = buildPrefillUrl(purchaseOrderId, projectId);
            try {
                const response = await fetch(prefillUrl);
                const payload = await response.json().catch(() => ({}));
                if (!payload || payload.ok !== true) {
                    updateDebug({
                        status: response.status,
                        url: prefillUrl,
                        supplierId: payload.supplier_id || "-",
                        amount: payload.amount || "-",
                        error: payload.error || "prefill_failed",
                    });
                    handlePrefillFailure(payload.error || "prefill_failed", prefillUrl);
                    return;
                }
                applyPrefill({ ...payload, prefill_url: prefillUrl });
                return;
            } catch (error) {
                console.error("Purchase order prefill failed", error);
                handlePrefillFailure("prefill_failed", prefillUrl);
            }
        };

        requestType.addEventListener("change", () => {
            if ((requestType.value || "").trim() !== "مشتريات") {
                purchaseOrderSelect.value = "";
            }
            clearPrefill();
            loadPurchaseOrders();
        });
        projectSelect.addEventListener("change", () => {
            purchaseOrderSelect.value = "";
            clearPrefill();
            loadPurchaseOrders(purchaseOrderSelect.value);
        });
        purchaseOrderSelect.addEventListener("change", handlePurchaseOrderChange);
        supplierSelect.addEventListener("change", updateManualValues);
        amountInput.addEventListener("input", updateManualValues);

        loadPurchaseOrders(purchaseOrderSelect.value).then(() => {
            if (purchaseOrderSelect.value) {
                handlePurchaseOrderChange();
            }
        });
    });
</script>
{% endblock %}
