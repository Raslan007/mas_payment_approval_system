{% extends "base.html" %}
{% block title %}{{ page_title or "تعديل الدفعة" }}{% endblock %}

{% block content %}
{% set page_title = page_title or ("تعديل الدفعة رقم " ~ payment.id) %}
{% set is_procurement = current_user.role and current_user.role.name == 'procurement' %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h5 mb-1">{{ page_title }}</h1>
        <div class="card-header-subtitle">
            قم بتعديل بيانات الدفعة ثم اضغط حفظ.
        </div>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('payments.detail', payment_id=payment.id) }}"
           class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-right-circle ms-1"></i>
            رجوع لتفاصيل الدفعة
        </a>
        <a href="{{ url_for('payments.index') }}"
           class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-list-task ms-1"></i>
            قائمة الدفعات
        </a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">

        <form method="post"
              action="{{ url_for('payments.edit_payment', payment_id=payment.id) }}"
              enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="row g-3">

                <!-- المشروع -->
                <div class="col-md-6">
                    <label for="project_id" class="form-label small mb-1">المشروع</label>
                    <select class="form-select form-select-sm" id="project_id" name="project_id" required>
                        <option value="">اختر المشروع...</option>
                        {% for proj in projects %}
                            <option value="{{ proj.id }}"
                                {% if payment.project_id == proj.id %}selected{% endif %}>
                                {{ proj.project_name }}
                                {% if proj.code %}- ({{ proj.code }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- المورد / المقاول -->
                <div class="col-md-6">
                    <label for="supplier_id" class="form-label small mb-1">المورد / المقاول</label>
                    <select class="form-select form-select-sm" id="supplier_id" name="supplier_id" required>
                        <option value="">اختر المورد / المقاول...</option>
                        {% for s in suppliers %}
                            <option value="{{ s.id }}"
                                {% if payment.supplier_id == s.id %}selected{% endif %}>
                                {{ s.name }}
                                {% if s.supplier_type %}- ({{ s.supplier_type }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- نوع الدفعة -->
                <div class="col-md-6">
                    <label for="request_type" class="form-label small mb-1">نوع الدفعة</label>
                    <select class="form-select form-select-sm" id="request_type" name="request_type" required>
                        {% if is_procurement %}
                            <option value="{{ payment.request_type }}">{{ payment.request_type }}</option>
                        {% else %}
                            <option value="">اختر نوع الدفعة...</option>
                            {% for rt in request_types %}
                                <option value="{{ rt }}"
                                    {% if payment.request_type == rt %}selected{% endif %}>
                                    {{ rt }}
                                </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- أمر الشراء -->
                <div class="col-md-6 {% if payment.request_type != 'مشتريات' %}d-none{% endif %}" id="purchase_order_field">
                    <label for="purchase_order_id" class="form-label small mb-1">أمر الشراء</label>
                    <select class="form-select form-select-sm" id="purchase_order_id" name="purchase_order_id">
                        <option value="">اختر أمر الشراء...</option>
                        {% for po in purchase_orders %}
                            <option value="{{ po.id }}" data-project-id="{{ po.project_id }}"
                                {% if payment.purchase_order_id == po.id %}selected{% endif %}>
                                أمر شراء {{ po.bo_number }} - المتبقي {{ po.remaining_amount | num(2) }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="form-text xsmall">
                        حدد أمر الشراء المرتبط بالدفعة لطلبات المشتريات.
                    </div>
                </div>

                <!-- قيمة الدفعة -->
                <div class="col-md-6">
                    <label for="amount" class="form-label small mb-1">قيمة الدفعة (ج.م)</label>
                    <input type="number" step="0.01" min="0"
                           class="form-control form-control-sm"
                           id="amount" name="amount"
                           value="{{ payment.amount }}"
                           required>
                </div>

                <!-- نسبة الإنجاز -->
                <div class="col-md-6">
                    <label for="progress_percentage" class="form-label small mb-1">
                        نسبة الإنجاز وقت طلب الدفعة (%)
                    </label>
                    <input type="number" step="1" min="0" max="100"
                           class="form-control form-control-sm"
                           id="progress_percentage" name="progress_percentage"
                           value="{{ payment.progress_percentage if payment.progress_percentage is not none }}">
                    <div class="form-text xsmall">
                        أدخل نسبة الإنجاز التقريبية وقت طلب هذه الدفعة.
                    </div>
                </div>

                <!-- وصف الدفعة -->
                <div class="col-12">
                    <label for="description" class="form-label small mb-1">وصف مختصر للدفعة</label>
                    <textarea class="form-control form-control-sm"
                              id="description" name="description"
                              rows="3"
                              placeholder="مثال: دفعة مستخلص رقم 3 للمقاول ...">{{ payment.description or "" }}</textarea>
                </div>

                <!-- المرفقات (اختياري) -->
                <div class="col-12">
                    <label for="attachment" class="form-label small mb-1">
                        مرفقات إضافية (اختياري)
                    </label>
                    <input type="file"
                           class="form-control form-control-sm"
                           id="attachment" name="attachment"
                           disabled>
                    <div class="form-text xsmall text-muted">
                        رفع المرفقات سيتم تفعيله قريباً.
                    </div>
                    {% if payment.attachments and config.ATTACHMENTS_ENABLED %}
                        <div class="mt-2 xsmall">
                            المرفقات الحالية:
                            <ul class="mb-0">
                                {% for att in payment.attachments %}
                                    <li>
                                        <a href="{{ url_for('payments.download_attachment', attachment_id=att.id) }}">
                                            {{ att.original_filename }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% elif payment.attachments %}
                        <div class="mt-2 xsmall text-muted">
                            تم تعطيل تحميل المرفقات حالياً.
                        </div>
                    {% endif %}
                </div>

            </div>

            <hr class="my-4">

            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted xsmall">
                    آخر تحديث:
                    {% if payment.updated_at %}
                        {{ payment.updated_at.strftime("%Y-%m-%d %H:%M") }}
                    {% else %}
                        لم يتم التحديث بعد
                    {% endif %}
                </div>

                <div class="d-flex gap-2">
                    <a href="{{ url_for('payments.detail', payment_id=payment.id) }}"
                       class="btn btn-outline-secondary btn-sm">
                        إلغاء
                    </a>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-save ms-1"></i>
                        حفظ التعديلات
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>

<script>
    (function () {
        const requestType = document.getElementById("request_type");
        const projectSelect = document.getElementById("project_id");
        const purchaseOrderField = document.getElementById("purchase_order_field");
        const purchaseOrderSelect = document.getElementById("purchase_order_id");

        if (!requestType || !purchaseOrderField || !purchaseOrderSelect) {
            return;
        }

        const togglePurchaseOrderField = () => {
            const isPurchase = (requestType.value || "").trim() === "مشتريات";
            purchaseOrderField.classList.toggle("d-none", !isPurchase);
            purchaseOrderSelect.required = isPurchase;
            if (!isPurchase) {
                purchaseOrderSelect.value = "";
            }
            filterPurchaseOrders();
        };

        const filterPurchaseOrders = () => {
            if (!projectSelect) {
                return;
            }
            const projectId = projectSelect.value;
            const options = purchaseOrderSelect.querySelectorAll("option[data-project-id]");
            options.forEach((option) => {
                const matches = !projectId || option.dataset.projectId === projectId;
                option.hidden = !matches;
                option.disabled = !matches;
            });
            if (
                purchaseOrderSelect.value
                && purchaseOrderSelect.selectedOptions.length
                && purchaseOrderSelect.selectedOptions[0].hidden
            ) {
                purchaseOrderSelect.value = "";
            }
        };

        requestType.addEventListener("change", togglePurchaseOrderField);
        if (projectSelect) {
            projectSelect.addEventListener("change", filterPurchaseOrders);
        }

        filterPurchaseOrders();
        togglePurchaseOrderField();
    })();
</script>
{% endblock %}
