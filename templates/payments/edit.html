{% extends "base.html" %}
{% block title %}تعديل الدفعة رقم {{ payment.id }}{% endblock %}

{% block content %}
{% set page_title = "تعديل الدفعة رقم " ~ payment.id %}

<div class="mb-3 d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
    <div>
        <h1 class="h5 mb-1">تعديل الدفعة رقم {{ payment.id }}</h1>
        <p class="text-muted xsmall mb-0">
            يمكنك تعديل بيانات الدفعة طالما أنها ما زالت في مرحلة المسودة أو طبقًا لصلاحياتك.
        </p>
    </div>
    <div>
        <span class="badge bg-{{ payment.status_badge_class }}">
            {{ payment.human_status }}
        </span>
    </div>
</div>

<div class="bg-white p-4 rounded-3 shadow-sm">
    <form method="post" novalidate>

        <div class="row g-3">
            <!-- المشروع -->
            <div class="col-md-6">
                <label class="form-label">المشروع</label>
                <div class="d-flex gap-2">
                    <select name="project_id" class="form-select" title="المشروع" required>
                        <option value="">اختر المشروع...</option>
                        {% for project in projects %}
                            <option value="{{ project.id }}"
                                    {% if payment.project_id == project.id %}selected{% endif %}>
                                {{ project.project_name }}
                            </option>
                        {% endfor %}
                    </select>

                    {% if current_user.role and current_user.role.name in ['admin', 'engineering_manager'] %}
                        <a href="{{ url_for('projects.create_project') }}" target="_blank"
                           class="btn btn-outline-secondary">
                            +
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- المورد / المقاول -->
            <div class="col-md-6">
                <label class="form-label">المورد / المقاول</label>
                <div class="d-flex gap-2">
                    <select name="supplier_id" class="form-select" title="المورد / المقاول" required>
                        <option value="">اختر المورد أو المقاول...</option>
                        {% for s in suppliers %}
                            <option value="{{ s.id }}"
                                    {% if payment.supplier_id == s.id %}selected{% endif %}>
                                {{ s.name }} ({{ s.supplier_type }})
                            </option>
                        {% endfor %}
                    </select>

                    {% if current_user.role and current_user.role.name in ['admin', 'engineering_manager'] %}
                        <a href="{{ url_for('suppliers.create_supplier') }}" target="_blank"
                           class="btn btn-outline-secondary">
                            +
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- نوع الدفعة -->
            <div class="col-md-4">
                <label class="form-label">نوع الدفعة</label>
                <select name="request_type" class="form-select" title="نوع الدفعة">
                    <option value="مقاول" {% if payment.request_type == "مقاول" %}selected{% endif %}>مقاول</option>
                    <option value="مشتريات" {% if payment.request_type == "مشتريات" %}selected{% endif %}>مشتريات</option>
                    <option value="عهدة" {% if payment.request_type == "عهدة" %}selected{% endif %}>عهدة</option>
                </select>
            </div>

            <!-- المبلغ -->
            <div class="col-md-4">
                <label class="form-label">المبلغ</label>
                <input type="number" step="0.01" name="amount" class="form-control"
                       title="المبلغ"
                       value="{{ '%.2f'|format(payment.amount) }}" required>
            </div>

            <!-- نسبة الإنجاز -->
            <div class="col-md-4">
                <label class="form-label">نسبة الإنجاز وقت هذه الدفعة (%)</label>
                <input type="number" step="0.01" min="0" max="100"
                       name="progress_percentage"
                       class="form-control"
                       value="{{ payment.progress_percentage if payment.progress_percentage is not none else '' }}"
                       placeholder="مثال: 25 أو 50.5">
                <small class="text-muted xsmall">
                    اختياري – يمثل نسبة إنجاز بند/مرحلة المشروع عند طلب هذه الدفعة.
                </small>
            </div>

            <!-- الوصف -->
            <div class="col-12">
                <label class="form-label">وصف / ملاحظات</label>
                <textarea name="description" rows="3" class="form-control"
                          placeholder="أدخل الوصف أو الملاحظات">{{ payment.description or "" }}</textarea>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <a href="{{ url_for('payments.view_payment', payment_id=payment.id) }}"
               class="btn btn-outline-secondary">
                رجوع
            </a>
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check2-circle ms-1"></i>
                حفظ التعديلات
            </button>
        </div>
    </form>
</div>
{% endblock %}
