{% extends "base.html" %}
{% block title %}لوحة التحكم - نظام الدفعات{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="h4 mb-1">لوحة التحكم - نظام إدارة واعتماد الدفعات</h1>
    <p class="text-muted mb-0">
        نظرة سريعة على حالة الدفعات، المشاريع والموردين في النظام.
    </p>
</div>

<!-- الكروت العلوية -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="bg-white p-3 rounded-3 shadow-sm h-100">
            <div class="text-muted small mb-1">إجمالي عدد الدفعات</div>
            <div class="h4 mb-0">{{ total_payments_count }}</div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="bg-white p-3 rounded-3 shadow-sm h-100">
            <div class="text-muted small mb-1">إجمالي مبلغ كل الدفعات</div>
            <div class="h4 mb-0">
                {{ "%.2f"|format(total_payments_amount) }}
                <span class="text-muted small">ج.م</span>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="bg-white p-3 rounded-3 shadow-sm h-100">
            <div class="text-muted small mb-1">عدد المشاريع المسجلة</div>
            <div class="h4 mb-0">{{ total_projects }}</div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="bg-white p-3 rounded-3 shadow-sm h-100">
            <div class="text-muted small mb-1">عدد الموردين / المقاولين</div>
            <div class="h4 mb-0">{{ total_suppliers }}</div>
        </div>
    </div>
</div>

<div class="row g-3">
    <!-- جدول الحالات -->
    <div class="col-lg-6">
        <div class="bg-white p-3 rounded-3 shadow-sm h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 mb-0">توزيع الدفعات حسب الحالة</h2>
                <a href="{{ url_for('payments.index') }}" class="btn btn-sm btn-outline-primary">
                    الذهاب لقائمة الدفعات
                </a>
            </div>

            {% if status_stats %}
                <table class="table table-sm align-middle mb-0">
                    <thead>
                    <tr>
                        <th>الحالة</th>
                        <th class="text-center">عدد الدفعات</th>
                        <th class="text-end">إجمالي المبلغ</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for s in status_stats %}
                        <tr>
                            <td>
                                <span class="badge bg-{{ s.badge }}">
                                    {{ s.label }}
                                </span>
                            </td>
                            <td class="text-center">{{ s.count }}</td>
                            <td class="text-end">
                                {{ "%.2f"|format(s.amount) }}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted mb-0">
                    لا توجد بيانات دفعات حتى الآن لعرض توزيع الحالات.
                </p>
            {% endif %}
        </div>
    </div>

    <!-- رسم بياني لأنواع الدفعات -->
    <div class="col-lg-6">
        <div class="bg-white p-3 rounded-3 shadow-sm h-100">
            <h2 class="h6 mb-3">توزيع الدفعات حسب النوع</h2>

            {% if type_stats %}
                <canvas id="typesChart" height="160"></canvas>
            {% else %}
                <p class="text-muted mb-0">
                    لا توجد بيانات كافية لعرض مخطط الأنواع.
                </p>
            {% endif %}
        </div>
    </div>
</div>

{% if type_stats %}
    <!-- تضمين Chart.js من CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const ctx = document.getElementById('typesChart').getContext('2d');

            // eslint-disable-next-line no-undef
            const labels = JSON.parse('{{ type_stats | map(attribute="type") | list | tojson }}');
            const counts = JSON.parse('{{ type_stats | map(attribute="count") | list | tojson }}');
            const amounts = JSON.parse('{{ type_stats | map(attribute="amount") | list | tojson }}');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'عدد الدفعات',
                            data: counts,
                            borderWidth: 1,
                            yAxisID: 'yCount'
                        },
                        {
                            label: 'إجمالي المبالغ',
                            data: amounts,
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'yAmount'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        yCount: {
                            type: 'linear',
                            position: 'left',
                            ticks: {
                                precision: 0
                            }
                        },
                        yAmount: {
                            type: 'linear',
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        })();
    </script>
{% endif %}
{% endblock %}
